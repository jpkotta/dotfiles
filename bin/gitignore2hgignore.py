#!/usr/bin/env python
# -*- coding:utf-8 -*-

import sys
import os
import re

def print_help():
    print "Usage: %s <directory>" % sys.argv[0]
    print
    print "Searches the entire directory tree below <directory> for files named"
    print "'.gitignore', then converts the data in these files to a .hgignore"
    print "file in <directory>."
    exit(1)    

try:
    topdir = sys.argv[1]
except IndexError:
    print_help()

os.chdir(topdir)
gitignores = os.popen("find . -name '.hg*' -prune -o -type f -name .gitignore -print") 

# outfile_name = "%s/.hgignore" % topdir
# outfile_name_bck = outfile_name + ".bck"
out = sys.stdout #open(outfile_name, "w")

out.write("# Mercurial ignore list, autogenerated from .gitignore files.\n")
out.write("syntax: glob\n\n")

for gitignore in gitignores:

    gitignore = gitignore.strip()
    
    path = gitignore
    path = re.sub("^\\./", "", path)
    path = re.sub(".gitignore$", "", path)
    
    header = "#"*72 + "\n# %s.gitignore\n\n" % (path)
    out.write(header)
    
    tmp = open(gitignore, "r")
    for line in tmp.readlines():

        # prepend the path if not a comment or whitespace
        if not (re.search("^\s*#", line) \
                or re.search("^\s*$", line)):
            line = path + line
        out.write(line)

    out.write("\n")
        
out.close()        
